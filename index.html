<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Constellation Walker</title>
    
    <!-- Mapbox CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --glow-primary: #FFFFFF;
            --glow-secondary: #808080;
            --glow-accent: #C0C0C0;
            --glass-bg: rgba(0, 0, 0, 0.85);
            --glass-border: rgba(255, 255, 255, 0.05);
            --noir-shadow: 0 0 100px rgba(0, 0, 0, 0.9);
        }
        
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            background: #000;
        }
        
        .mapboxgl-ctrl-logo,
        .mapboxgl-ctrl-attrib,
        .mapboxgl-ctrl-top-right {
            display: none !important;
        }
        
        /* GPS Debug Info - NEW */
        .gps-debug {
            position: absolute;
            top: 60px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 10px;
            font-size: 11px;
            font-family: monospace;
            color: #0f0;
            z-index: 2000;
            max-width: 200px;
        }
        
        /* My Star Marker - Enhanced visibility */
        .star-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: relative;
            z-index: 100;
            background: radial-gradient(circle at 30% 30%, 
                currentColor, 
                transparent 70%);
            filter: blur(0.5px);
            animation: starPulse 3s ease-in-out infinite;
        }
        
        .star-marker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center,
                currentColor 0%,
                transparent 40%);
            opacity: 0.6;
            animation: starGlow 2s ease-in-out infinite alternate;
        }
        
        .star-marker.mine {
            width: 40px;
            height: 40px;
            z-index: 500;
            filter: blur(0px);
            color: #00D4FF !important;
            box-shadow: 0 0 30px currentColor;
        }
        
        .star-marker.mine::before {
            width: 300%;
            height: 300%;
            animation: myStarGlow 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes starPulse {
            0%, 100% { 
                transform: scale(1);
                filter: brightness(1) blur(0.5px);
            }
            50% { 
                transform: scale(1.15);
                filter: brightness(1.5) blur(0.3px);
            }
        }
        
        @keyframes starGlow {
            0% { 
                opacity: 0.4;
                transform: translate(-50%, -50%) scale(1);
            }
            100% { 
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }
        
        @keyframes myStarGlow {
            0% { 
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
                filter: blur(3px);
            }
            100% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.3);
                filter: blur(5px);
            }
        }
        
        /* Echo Markers */
        .echo-marker {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: linear-gradient(135deg, 
                rgba(0, 0, 0, 0.3),
                rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px) saturate(200%);
            -webkit-backdrop-filter: blur(10px) saturate(200%);
            z-index: 50;
            animation: echoFloat 4s ease-in-out infinite;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        }
        
        @keyframes echoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        /* Top UI */
        .top-info {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            pointer-events: none;
        }
        
        .user-count {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.05),
                rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            letter-spacing: 0.5px;
        }
        
        /* Echo Button - ALWAYS VISIBLE */
        .echo-button {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 40px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            color: white;
            border: none;
            width: 75px;
            height: 75px;
            border-radius: 50%;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 10px 40px rgba(102, 126, 234, 0.4),
                inset 0 2px 10px rgba(255, 255, 255, 0.3);
            animation: buttonPulse 2s ease-in-out infinite;
        }
        
        .echo-button:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 
                    0 10px 40px rgba(102, 126, 234, 0.4),
                    0 0 0 0 rgba(102, 126, 234, 0.4),
                    inset 0 2px 10px rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow: 
                    0 10px 40px rgba(102, 126, 234, 0.6),
                    0 0 0 15px rgba(102, 126, 234, 0.1),
                    inset 0 2px 10px rgba(255, 255, 255, 0.4);
            }
        }
        
        /* Echo Menu */
        .echo-menu {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 140px);
            left: 50%;
            transform: translateX(-50%) scale(0);
            z-index: 999;
            display: flex;
            gap: 18px;
            background: linear-gradient(135deg,
                rgba(0, 0, 0, 0.7),
                rgba(30, 30, 30, 0.5));
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            padding: 22px;
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .echo-menu.visible {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }
        
        .echo-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg,
                rgba(255, 255, 255, 0.08),
                rgba(255, 255, 255, 0.02));
            color: white;
            font-size: 26px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .echo-option:hover {
            transform: scale(1.15) translateY(-8px);
            border-color: var(--glow-primary);
            background: linear-gradient(135deg,
                rgba(0, 212, 255, 0.2),
                rgba(255, 0, 234, 0.1));
            box-shadow: 
                0 15px 30px rgba(0, 212, 255, 0.3),
                inset 0 0 20px rgba(0, 212, 255, 0.1);
        }
        
        /* Loading Screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, 
                #0a0a0f 0%, 
                #000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.8s ease-out;
        }
        
        .loading-star {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%,
                var(--glow-primary),
                transparent 70%);
            box-shadow: 
                0 0 100px var(--glow-primary),
                0 0 200px var(--glow-secondary);
            animation: loadingPulse 2s ease-in-out infinite;
        }
        
        @keyframes loadingPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        .loading-text {
            margin-top: 40px;
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: uppercase;
            background: linear-gradient(90deg,
                var(--glow-primary),
                var(--glow-secondary),
                var(--glow-accent));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textShimmer 3s ease-in-out infinite;
        }
        
        @keyframes textShimmer {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        /* Status Indicator */
        .status {
            position: absolute;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 15px);
            right: 15px;
            background: linear-gradient(135deg,
                rgba(0, 0, 0, 0.8),
                rgba(20, 20, 20, 0.6));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: statusPulse 2s ease-in-out infinite;
        }
        
        .status.connected .status-dot { 
            background: #00ff88;
            box-shadow: 
                0 0 10px #00ff88,
                0 0 20px #00ff88;
        }
        
        .status.disconnected .status-dot { 
            background: #ff3366;
            box-shadow: 
                0 0 10px #ff3366,
                0 0 20px #ff3366;
        }
        
        @keyframes statusPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="loading-star"></div>
        <div class="loading-text">Entering Constellation</div>
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- GPS Debug Info -->
    <div id="gpsDebug" class="gps-debug">
        GPS: Waiting...<br>
        Lat: --<br>
        Lng: --<br>
        Accuracy: --
    </div>
    
    <!-- Top Info -->
    <div class="top-info">
        <div class="user-count">
            <span id="activeUsers">0</span> stars nearby ✨
        </div>
    </div>
    
    <!-- Echo Button - Always Visible -->
    <button id="echoButton" class="echo-button">✨</button>
    
    <!-- Echo Menu -->
    <div id="echoMenu" class="echo-menu">
        <div class="echo-option" data-type="audio">🎤</div>
        <div class="echo-option" data-type="photo">📷</div>
        <div class="echo-option" data-type="video">🎥</div>
        <div class="echo-option" data-type="mood">💭</div>
        <div class="echo-option" data-type="text">💬</div>
    </div>
    
    <!-- Connection Status -->
    <div id="status" class="status disconnected">
        <span class="status-dot"></span>
        <span>Connecting...</span>
    </div>
    
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ============================================
        // CONFIGURAȚIE SUPABASE + MAPBOX
        // ============================================
        const SUPABASE_URL = 'https://wajgxfgeumpztjyafyem.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indhamd4ZmdldW1wenRqeWFmeWVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU0MDcxMDYsImV4cCI6MjA1MDk4MzEwNn0.qGu5u8ZqeEXYHwAYA4iARW0L0BB8XtwwZpxIKMp6Afc';
        const MAPBOX_TOKEN = 'pk.eyJ1IjoidmxhZHN0YXIiLCJhIjoiY21lcXVrZWRkMDR2MDJrczczYTFvYTBvMiJ9.H36WPQ21h1CTjbEb32AT1g';
        const MAPBOX_STYLE = 'mapbox://styles/vladstar/cmetspgr7003g01sc2aeub7yg';
        
        // Inițializare Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variabile globale
        let map;
        let userMarker;
        let userId;
        let userColor;
        let lastPosition = null;
        let otherUsersMarkers = new Map();
        let echoMarkers = new Map();
        let positionSubscription = null;
        let echoSubscription = null;
        let watchId = null; // Pentru GPS watch
        let hasInitialPosition = false; // Flag pentru prima poziție
        
        // ============================================
        // DEBUG FUNCTIONS
        // ============================================
        
        function updateGPSDebug(message, lat = '--', lng = '--', accuracy = '--') {
            const debug = document.getElementById('gpsDebug');
            debug.innerHTML = `
                GPS: ${message}<br>
                Lat: ${typeof lat === 'number' ? lat.toFixed(6) : lat}<br>
                Lng: ${typeof lng === 'number' ? lng.toFixed(6) : lng}<br>
                Accuracy: ${typeof accuracy === 'number' ? Math.round(accuracy) + 'm' : accuracy}
            `;
        }
        
        // ============================================
        // FUNCȚII UTILITATE
        // ============================================
        
        function getOrCreateUserId() {
            let id = localStorage.getItem('constellation-user-id');
            if (!id) {
                id = crypto.randomUUID();
                localStorage.setItem('constellation-user-id', id);
            }
            return id;
        }
        
        function generateStarColor() {
            const colors = [
                '#00D4FF', // Cyan
                '#FF00EA', // Magenta
                '#FFD700', // Gold
                '#00FF88', // Mint
                '#FF6B6B', // Coral
                '#A78BFA', // Purple
                '#60A5FA', // Sky
                '#F472B6'  // Pink
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        async function ensureUserExists() {
            userColor = generateStarColor();
            
            const { data: existingUser } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (!existingUser) {
                await supabaseClient
                    .from('users')
                    .insert({
                        id: userId,
                        color_hash: userColor
                    });
            } else {
                userColor = existingUser.color_hash;
            }
        }
        
        // ============================================
        // MAPBOX SETUP - SIMPLIFIED (NO AUTO-ROTATE)
        // ============================================
        
        function initMap() {
            mapboxgl.accessToken = MAPBOX_TOKEN;
            
            map = new mapboxgl.Map({
                container: 'map',
                style: MAPBOX_STYLE,
                center: [26.1246, 44.4808], // București default
                zoom: 16,
                pitch: 0, // Start flat
                bearing: 0,
                antialias: true,
                fadeDuration: 300
            });
            
            map.on('load', async () => {
                console.log('Map loaded successfully');
                
                // Add constellation lines layer
                map.addSource('constellation-lines', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: []
                    }
                });
                
                map.addLayer({
                    id: 'constellation-layer',
                    type: 'line',
                    source: 'constellation-lines',
                    paint: {
                        'line-color': '#00D4FF',
                        'line-width': 2,
                        'line-opacity': 0.6
                    },
                    layout: {
                        'line-cap': 'round',
                        'line-join': 'round'
                    }
                });
                
                // Hide loading
                const loading = document.getElementById('loading');
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 800);
                
                // Ensure user exists
                await ensureUserExists();
                
                // Start everything
                startRealtimeSync();
                startLocationTracking();
                loadInitialData();
                setupEventListeners();
                
                console.log('All systems initialized');
            });
        }
        
        // ============================================
        // REALTIME SYNC CU SUPABASE
        // ============================================
        
        function startRealtimeSync() {
            console.log('Starting realtime sync...');
            
            // Subscribe la schimbări în active_positions
            positionSubscription = supabaseClient
                .channel('positions')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'active_positions'
                }, (payload) => {
                    console.log('Position change:', payload);
                    handlePositionChange(payload);
                })
                .subscribe((status) => {
                    console.log('Position subscription status:', status);
                    updateConnectionStatus(status === 'SUBSCRIBED');
                });
            
            // Subscribe la schimbări în echoes
            echoSubscription = supabaseClient
                .channel('echoes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'echoes'
                }, (payload) => {
                    console.log('Echo change:', payload);
                    handleEchoChange(payload);
                })
                .subscribe();
        }
        
        function handlePositionChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            if (eventType === 'DELETE') {
                removeUserMarker(oldRecord.user_id);
            } else if (eventType === 'INSERT' || eventType === 'UPDATE') {
                if (newRecord.user_id !== userId) {
                    updateOtherUserMarker(newRecord.user_id, newRecord);
                }
            }
            
            updateUserCount();
            updateConstellations();
        }
        
        function handleEchoChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            if (eventType === 'DELETE') {
                removeEchoMarker(oldRecord.id);
            } else if (eventType === 'INSERT') {
                addEchoMarker(newRecord.id, newRecord);
            }
        }
        
        async function loadInitialData() {
            console.log('Loading initial data...');
            
            // Load active positions
            const { data: positions, error: posError } = await supabaseClient
                .from('active_positions')
                .select('*');
            
            if (posError) {
                console.error('Error loading positions:', posError);
            } else if (positions) {
                console.log(`Found ${positions.length} active users`);
                positions.forEach(pos => {
                    if (pos.user_id !== userId) {
                        updateOtherUserMarker(pos.user_id, pos);
                    }
                });
            }
            
            // Load echoes from last 24 hours
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const { data: echoes, error: echoError } = await supabaseClient
                .from('echoes')
                .select('*')
                .gte('created_at', oneDayAgo);
            
            if (echoError) {
                console.error('Error loading echoes:', echoError);
            } else if (echoes) {
                console.log(`Found ${echoes.length} echoes`);
                echoes.forEach(echo => {
                    addEchoMarker(echo.id, echo);
                });
            }
            
            updateUserCount();
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
            } else {
                status.className = 'status disconnected';
                status.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
            }
        }
        
        function updateUserCount() {
            const count = otherUsersMarkers.size + 1;
            document.getElementById('activeUsers').textContent = count;
        }
        
        // ============================================
        // USER MARKERS
        // ============================================
        
        function updateOtherUserMarker(id, data) {
            if (!data.lat || !data.lng) return;
            
            // Get user color from users table
            supabaseClient
                .from('users')
                .select('color_hash')
                .eq('id', id)
                .single()
                .then(({ data: userData }) => {
                    const color = userData?.color_hash || generateStarColor();
                    
                    if (otherUsersMarkers.has(id)) {
                        // Update existing marker
                        const marker = otherUsersMarkers.get(id).marker;
                        marker.setLngLat([data.lng, data.lat]);
                        otherUsersMarkers.get(id).position = [data.lng, data.lat];
                    } else {
                        // Create new marker
                        const el = document.createElement('div');
                        el.className = 'star-marker';
                        el.style.color = color;
                        
                        const marker = new mapboxgl.Marker(el)
                            .setLngLat([data.lng, data.lat])
                            .addTo(map);
                        
                        otherUsersMarkers.set(id, {
                            marker: marker,
                            position: [data.lng, data.lat],
                            color: color
                        });
                        
                        console.log(`Added new user marker: ${id}`);
                    }
                });
        }
        
        function removeUserMarker(id) {
            if (otherUsersMarkers.has(id)) {
                const { marker } = otherUsersMarkers.get(id);
                marker.remove();
                otherUsersMarkers.delete(id);
                updateUserCount();
                console.log(`Removed user marker: ${id}`);
            }
        }
        
        // ============================================
        // ECHO MARKERS
        // ============================================
        
        function addEchoMarker(id, data) {
            if (!data.lat || !data.lng) return;
            
            const echoTypes = {
                'audio': '🎤',
                'photo': '📷',
                'video': '🎥',
                'mood': '💭',
                'text': '💬'
            };
            
            const el = document.createElement('div');
            el.className = 'echo-marker';
            el.style.color = data.mood_color || '#667eea';
            el.style.borderColor = data.mood_color || '#667eea';
            el.innerHTML = echoTypes[data.content_type] || '✨';
            
            const marker = new mapboxgl.Marker(el)
                .setLngLat([data.lng, data.lat])
                .addTo(map);
            
            el.addEventListener('click', () => {
                showEchoDetails(data);
                
                // Update interaction count
                supabaseClient
                    .from('echoes')
                    .update({ interaction_count: (data.interaction_count || 0) + 1 })
                    .eq('id', id);
            });
            
            echoMarkers.set(id, marker);
        }
        
        function showEchoDetails(data) {
            // Create custom popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(30,30,30,0.8));
                backdrop-filter: blur(20px);
                padding: 30px;
                border-radius: 20px;
                border: 1px solid rgba(255,255,255,0.2);
                color: white;
                z-index: 10000;
                text-align: center;
                transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            `;
            
            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 15px;">${
                    data.content_type === 'audio' ? '🎤' : 
                    data.content_type === 'photo' ? '📷' : 
                    data.content_type === 'video' ? '🎥' : 
                    data.content_type === 'mood' ? '💭' : '💬'
                }</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Echo Discovered!</div>
                <div style="font-size: 14px; opacity: 0.8;">Type: ${data.content_type}</div>
                <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">Tap outside to close</div>
            `;
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.style.transform = 'translate(-50%, -50%) scale(1)';
            }, 10);
            
            const closePopup = (e) => {
                if (e.target !== popup && !popup.contains(e.target)) {
                    popup.style.transform = 'translate(-50%, -50%) scale(0)';
                    setTimeout(() => popup.remove(), 300);
                    document.removeEventListener('click', closePopup);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closePopup);
            }, 100);
        }
        
        function removeEchoMarker(id) {
            if (echoMarkers.has(id)) {
                const marker = echoMarkers.get(id);
                marker.remove();
                echoMarkers.delete(id);
            }
        }
        
        // ============================================
        // LOCATION TRACKING - REAL GPS ONLY
        // ============================================
        
        function startLocationTracking() {
            console.log('Starting GPS tracking...');
            updateGPSDebug('Requesting permission...');
            
            if (!navigator.geolocation) {
                console.error('Geolocation not supported');
                updateGPSDebug('Not supported!');
                alert('GPS is not supported on this device/browser');
                return;
            }
            
            // Request GPS with high accuracy
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    console.log('GPS Update:', position);
                    updateGPSDebug('Active', 
                        position.coords.latitude, 
                        position.coords.longitude, 
                        position.coords.accuracy
                    );
                    updatePosition(position);
                },
                (error) => {
                    console.error('GPS Error:', error);
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                }
            );
            
            // Also try to get immediate position
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('Initial position:', position);
                    updatePosition(position);
                },
                (error) => {
                    console.error('Initial position error:', error);
                }
            );
        }
        
        async function updatePosition(position) {
            const { latitude, longitude, speed, heading, altitude, accuracy } = position.coords;
            
            console.log(`Position update: ${latitude}, ${longitude}, accuracy: ${accuracy}m`);
            
            // Create or update user marker
            if (!userMarker) {
                const el = document.createElement('div');
                el.className = 'star-marker mine';
                el.style.color = userColor || '#00D4FF';
                
                userMarker = new mapboxgl.Marker(el)
                    .setLngLat([longitude, latitude])
                    .addTo(map);
                
                // Center map on first position
                if (!hasInitialPosition) {
                    hasInitialPosition = true;
                    map.flyTo({
                        center: [longitude, latitude],
                        zoom: 17,
                        duration: 2000,
                        essential: true
                    });
                }
            } else {
                userMarker.setLngLat([longitude, latitude]);
                
                // Optional: Follow user smoothly (uncomment if you want map to follow)
                // map.easeTo({
                //     center: [longitude, latitude],
                //     duration: 1000
                // });
            }
            
            lastPosition = { lat: latitude, lng: longitude };
            
            // Update in Supabase
            try {
                await supabaseClient
                    .from('active_positions')
                    .upsert({
                        user_id: userId,
                        lat: latitude,
                        lng: longitude,
                        altitude: altitude || 0,
                        speed: speed || 0,
                        heading: heading || 0,
                        updated_at: new Date().toISOString()
                    });
                
                // Update last_seen
                await supabaseClient
                    .from('users')
                    .update({ last_seen: new Date().toISOString() })
                    .eq('id', userId);
                    
                updateConstellations();
            } catch (error) {
                console.error('Error updating position in Supabase:', error);
            }
        }
        
        function handleLocationError(error) {
            let errorMessage = 'Unknown error';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Permission denied';
                    alert('Please enable location services for this app');
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Position unavailable';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Timeout';
                    break;
            }
            
            updateGPSDebug(errorMessage);
            console.error('Location error:', errorMessage, error);
        }
        
        // ============================================
        // CONSTELLATIONS - SIMPLE LINES
        // ============================================
        
        function updateConstellations() {
            if (!lastPosition || !map.getSource('constellation-lines')) return;
            
            const features = [];
            const nearbyUsers = Array.from(otherUsersMarkers.values())
                .map(user => ({
                    ...user,
                    distance: calculateDistance(
                        lastPosition.lat, lastPosition.lng,
                        user.position[1], user.position[0]
                    )
                }))
                .filter(user => user.distance < 500) // 500m range
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5); // Max 5 connections
            
            // Create lines to nearby users
            nearbyUsers.forEach(user => {
                features.push({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: [
                            [lastPosition.lng, lastPosition.lat],
                            user.position
                        ]
                    }
                });
            });
            
            map.getSource('constellation-lines').setData({
                type: 'FeatureCollection',
                features: features
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        function setupEventListeners() {
            // Echo button - always visible
            const echoButton = document.getElementById('echoButton');
            echoButton.addEventListener('click', () => {
                const menu = document.getElementById('echoMenu');
                menu.classList.toggle('visible');
                
                // Vibration feedback if available
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
            
            // Echo options
            document.querySelectorAll('.echo-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    console.log(`Echo type selected: ${type}`);
                    dropEcho(type);
                    
                    if (navigator.vibrate) {
                        navigator.vibrate([50, 50, 50]);
                    }
                });
            });
            
            // Cleanup on page unload
            window.addEventListener('beforeunload', async () => {
                if (userId) {
                    await supabaseClient
                        .from('active_positions')
                        .delete()
                        .eq('user_id', userId);
                }
                
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                }
            });
        }
        
        // ============================================
        // DROP ECHO
        // ============================================
        
        async function dropEcho(type) {
            if (!lastPosition) {
                alert('No GPS position available');
                return;
            }
            
            const echoId = crypto.randomUUID();
            const color = generateStarColor();
            
            console.log(`Dropping ${type} echo at:`, lastPosition);
            
            // Create echo in database
            try {
                const { error } = await supabaseClient
                    .from('echoes')
                    .insert({
                        id: echoId,
                        user_id: userId,
                        lat: lastPosition.lat,
                        lng: lastPosition.lng,
                        content_type: type,
                        mood_color: color
                    });
                    
                if (error) {
                    console.error('Error creating echo:', error);
                    alert('Failed to create echo');
                } else {
                    console.log('Echo created successfully');
                    // Hide menu
                    document.getElementById('echoMenu').classList.remove('visible');
                    
                    // Visual feedback
                    createEchoDropEffect(lastPosition, color);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function createEchoDropEffect(position, color) {
            // Create expanding ring effect
            const el = document.createElement('div');
            el.style.cssText = `
                width: 100px;
                height: 100px;
                border: 3px solid ${color};
                border-radius: 50%;
                pointer-events: none;
                opacity: 1;
                transform: scale(0);
            `;
            
            const marker = new mapboxgl.Marker(el)
                .setLngLat([position.lng, position.lat])
                .addTo(map);
            
            // Animate
            requestAnimationFrame(() => {
                el.style.transition = 'all 1.5s ease-out';
                el.style.transform = 'scale(3)';
                el.style.opacity = '0';
            });
            
            setTimeout(() => marker.remove(), 1500);
        }
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        console.log('Starting Constellation Walker...');
        userId = getOrCreateUserId();
        console.log('User ID:', userId);
        initMap();
    </script>
</body>
</html>
